<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phonetic Audio Test - Quran Reader</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #2c5282 0%, #2d3748 100%);
            color: white;
            min-height: 100vh;
        }
        .test-box {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        button {
            padding: 12px 20px;
            margin: 8px;
            border: none;
            border-radius: 25px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .arabic {
            font-size: 2em;
            text-align: center;
            margin: 15px 0;
            direction: rtl;
        }
        .phonetic {
            font-style: italic;
            text-align: center;
            margin: 10px 0;
            opacity: 0.8;
        }
        .status {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        .success { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
        .error { background: rgba(244, 67, 54, 0.2); color: #f44336; }
        .playing { background: #ff9800 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body>
    <h1>🎵 Phonetic Audio Solution Test</h1>
    <p>Testing the phonetic pronunciation fallback for systems without Arabic voices</p>
    
    <div class="test-box">
        <h2>🔧 System Check</h2>
        <div class="status" id="systemStatus">Checking audio capabilities...</div>
        <button onclick="checkSystem()">🔍 Test System Capabilities</button>
    </div>
    
    <div class="test-box">
        <h2>🎙️ Phonetic TTS Test</h2>
        <p>These tests use English phonetic pronunciations for Arabic words:</p>
        
        <div class="arabic">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ</div>
        
        <div style="text-align: center;">
            <button onclick="testPhoneticWord('بِسْمِ', 'bis-mi')">Play "بِسْمِ" → "bis-mi"</button>
            <button onclick="testPhoneticWord('اللَّهِ', 'al-lah-hi')">Play "اللَّهِ" → "al-lah-hi"</button>
            <button onclick="testPhoneticWord('الرَّحْمَنِ', 'ar-rah-man-i')">Play "الرَّحْمَنِ" → "ar-rah-man-i"</button>
            <button onclick="testPhoneticWord('الرَّحِيمِ', 'ar-ra-heem')">Play "الرَّحِيمِ" → "ar-ra-heem"</button>
        </div>
        <div class="status" id="phoneticStatus">Ready to test phonetic pronunciation...</div>
    </div>
    
    <div class="test-box">
        <h2>🎶 Musical Tone Fallback</h2>
        <p>For words without phonetic mappings, generate musical tones:</p>
        <div style="text-align: center;">
            <button onclick="testWordTone('الْحَمْدُ')">🎵 Generate tone for "الْحَمْدُ"</button>
            <button onclick="testWordTone('نَعْبُدُ')">🎵 Generate tone for "نَعْبُدُ"</button>
            <button onclick="testWordTone('الْمُسْتَقِيمَ')">🎵 Generate tone for "الْمُسْتَقِيمَ"</button>
        </div>
        <div class="status" id="toneStatus">Ready to test musical tones...</div>
    </div>
    
    <div class="test-box">
        <h2>🔄 Full Audio Cascade Test</h2>
        <p>Test the complete fallback chain: Arabic TTS → Phonetic English → Musical Tone</p>
        <button onclick="testFullCascade()">🔄 Test Complete Audio Cascade</button>
        <div class="status" id="cascadeStatus">Ready to test full cascade...</div>
    </div>

    <script>
        let audioContext = null;
        
        // Phonetic mapping (copied from main app)
        const phoneticMap = {
            'بِسْمِ': 'bis-mi',
            'اللَّهِ': 'al-lah-hi',
            'الرَّحْمَنِ': 'ar-rah-man-i',
            'الرَّحِيمِ': 'ar-ra-heem',
            'الْحَمْدُ': 'al-ham-du',
            'لِلَّهِ': 'lil-lah-hi',
            'رَبِّ': 'rab-bi',
            'الْعَالَمِينَ': 'al-ah-la-meen'
        };
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'status';
            if (type === 'success') element.classList.add('success');
            if (type === 'error') element.classList.add('error');
        }
        
        function checkSystem() {
            updateStatus('systemStatus', '🔍 Checking system capabilities...', 'info');
            
            let results = [];
            
            // Check TTS
            if ('speechSynthesis' in window) {
                results.push('✅ Text-to-Speech: Available');
                
                const voices = speechSynthesis.getVoices();
                const arabicVoices = voices.filter(v => v.lang.includes('ar'));
                if (arabicVoices.length > 0) {
                    results.push(`✅ Arabic voices: ${arabicVoices.length} found`);
                } else {
                    results.push('⚠️ Arabic voices: None found (will use phonetic fallback)');
                }
            } else {
                results.push('❌ Text-to-Speech: Not supported');
            }
            
            // Check Web Audio
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                results.push('✅ Web Audio API: Available');
            } catch (error) {
                results.push('❌ Web Audio API: Not supported');
            }
            
            updateStatus('systemStatus', results.join(' | '), 'success');
        }
        
        async function testPhoneticWord(arabicWord, phoneticText) {
            const button = event.target;
            button.classList.add('playing');
            button.disabled = true;
            
            updateStatus('phoneticStatus', `🎙️ Speaking "${arabicWord}" as "${phoneticText}"...`, 'info');
            
            try {
                await playPhoneticTTS(phoneticText);
                updateStatus('phoneticStatus', `✅ Successfully played "${arabicWord}" using phonetic pronunciation`, 'success');
            } catch (error) {
                updateStatus('phoneticStatus', `❌ Failed to play phonetic TTS: ${error.message}`, 'error');
            } finally {
                button.classList.remove('playing');
                button.disabled = false;
            }
        }
        
        function playPhoneticTTS(phoneticText) {
            return new Promise((resolve, reject) => {
                if (!('speechSynthesis' in window)) {
                    reject(new Error('Speech synthesis not supported'));
                    return;
                }
                
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(phoneticText);
                utterance.lang = 'en-US';
                utterance.rate = 0.7;
                utterance.pitch = 1.0;
                utterance.volume = 0.8;
                
                // Try to find a good English voice
                const voices = speechSynthesis.getVoices();
                const englishVoice = voices.find(v => v.lang === 'en-US') || 
                                   voices.find(v => v.lang.startsWith('en'));
                
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                
                utterance.onend = resolve;
                utterance.onerror = reject;
                
                speechSynthesis.speak(utterance);
            });
        }
        
        async function testWordTone(arabicWord) {
            const button = event.target;
            button.classList.add('playing');
            button.disabled = true;
            
            updateStatus('toneStatus', `🎶 Generating musical tone for "${arabicWord}"...`, 'info');
            
            try {
                await playWordTone(arabicWord);
                updateStatus('toneStatus', `✅ Successfully generated musical tone for "${arabicWord}"`, 'success');
            } catch (error) {
                updateStatus('toneStatus', `❌ Failed to generate tone: ${error.message}`, 'error');
            } finally {
                button.classList.remove('playing');
                button.disabled = false;
            }
        }
        
        function playWordTone(word) {
            return new Promise(async (resolve, reject) => {
                try {
                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                    
                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    
                    // Generate word-specific frequency
                    const wordHash = hashWord(word);
                    const baseFrequency = 220 + (wordHash % 400);
                    const syllableCount = estimateSyllables(word);
                    const toneDuration = Math.max(600, syllableCount * 300);
                    
                    const oscillators = [];
                    
                    for (let i = 0; i < syllableCount; i++) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        const frequency = baseFrequency + (i * 55);
                        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                        oscillator.type = 'sine';
                        
                        const startTime = audioContext.currentTime + (i * 0.2);
                        const duration = (toneDuration - i * 100) / 1000;
                        
                        gainNode.gain.setValueAtTime(0, startTime);
                        gainNode.gain.linearRampToValueAtTime(0.08, startTime + 0.05);
                        gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                        
                        oscillator.start(startTime);
                        oscillator.stop(startTime + duration);
                        
                        oscillators.push(oscillator);
                    }
                    
                    let resolvedCount = 0;
                    oscillators.forEach(osc => {
                        osc.onended = () => {
                            resolvedCount++;
                            if (resolvedCount === oscillators.length) {
                                resolve();
                            }
                        };
                    });
                    
                    setTimeout(resolve, toneDuration + 500);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function hashWord(word) {
            let hash = 0;
            for (let i = 0; i < word.length; i++) {
                const char = word.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash);
        }
        
        function estimateSyllables(arabicWord) {
            const normalizedWord = arabicWord.replace(/[\u064B-\u0652]/g, ''); // Remove diacritics
            const letterCount = normalizedWord.length;
            
            if (letterCount <= 2) return 1;
            if (letterCount <= 4) return 2;
            if (letterCount <= 6) return 3;
            return 4;
        }
        
        async function testFullCascade() {
            updateStatus('cascadeStatus', '🔄 Testing complete audio cascade...', 'info');
            
            const testWord = 'بِسْمِ';
            let results = [];
            
            // Step 1: Try Arabic TTS
            try {
                const voices = speechSynthesis.getVoices();
                const hasArabicVoice = voices.some(v => v.lang.includes('ar'));
                
                if (hasArabicVoice) {
                    results.push('✅ Step 1: Arabic TTS would work');
                } else {
                    results.push('⚠️ Step 1: No Arabic voices, moving to phonetic');
                    
                    // Step 2: Try phonetic TTS
                    const phoneticText = phoneticMap[testWord];
                    if (phoneticText) {
                        await playPhoneticTTS(phoneticText);
                        results.push('✅ Step 2: Phonetic TTS successful');
                    } else {
                        results.push('⚠️ Step 2: No phonetic mapping, using musical tone');
                        
                        // Step 3: Musical tone
                        await playWordTone(testWord);
                        results.push('✅ Step 3: Musical tone generated');
                    }
                }
            } catch (error) {
                results.push(`❌ Cascade failed: ${error.message}`);
            }
            
            updateStatus('cascadeStatus', results.join(' → '), 'success');
        }
        
        // Auto-check system on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkSystem, 500);
            
            // Load voices if not already loaded
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.onvoiceschanged = checkSystem;
            }
        });
    </script>
</body>
</html>